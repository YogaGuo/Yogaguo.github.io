---
title:  SQL语句是如何执行的?
date: 2020-02-11 18:38:40
tags: mysql
categories: mysql
---

###  MySQL逻辑架构

- 首先头脑中构建一副MySQL个组件是如何协同工作,MySQL最与众不同的地方在于它的存储引擎架构，这种架构的设计将查询处理(Query Processing)及其他系统任务(Server Task)和数据的存储 / 提取分离。更加高效。
  下面是MySQL的基本架构示意图，从这里可以看出SQL语句在各个组件间的执行过程  

    {% asset_img mysql.png  %}
  
- 最上层并不是MySQL独有的，大多数基于网络的客户端 / 服务器的工具或者服务都有相似的架构，比如连接处理  授权认证。。。。  
  
  
  
  第二次是MySQL的核心服务功能区(Server),包括连接器，查询缓存  分析器  优化器 ，执行器等待核心服务功能，以及所有的内置函数（日期，时间 数学加密),还有所有跨存储引擎的功能都在这一次实现，比如存储过程，触发器，视图等，还有一个通用的日志模块 binglog日志模块。  

    
  
  第三次包含了存储引擎。存储引擎负责数据的存储和提取。架构是插件式的。支持InnoDB,MyISAM,Memory多个存储引擎,其中InnoDB引擎有日志模块redolog 模块。  
  
  当执行建表的时候，如果不指定引擎类型，默认使用的就是InnoDB,当然，也可以通过指定引擎的类型选择，在 create table语句中用engine=memory来指定。
  如图所示，不同的存储引擎公用一个**Server层**
  
- ` select * from student where id=10;`

#### 连接器

第一步会先里连接数据库，**连接器会负责和客户端建立连接，获取权限，维持和管理连接**。如果用户账户密码已通过，连接器会到权限表中查询该用户的所有权限，之后在这个连接里的权限逻辑判断都是会依赖此时读取到的权限数据，也就是说在成功连接后，即使用管理员账号对这个用户权限做了修改，也不会影响已经存在的连接的权限，该用户不受影响的。在连接完成后，如果用户没有后序动作，这个连接就处于空闲态，如果**长时间**客户端没动静，连接器会自动断开，这时间由参数wait_timeout决定，默认8h.  

在连接断开后，下一次需要重连，在数据库中有长连接，短连接，前者指连接成功后，客户端持续有请求，则一直使用此连接，后者指每次执行很少的查询后就断开连接。下次再次连接。**建立连接是比较耗时的，所以尽量减少建立连接动作，尽量使用长连接，但是全部使用长连接，MySQL内存涨的很快，因为MySQL执行中临时使用的内存是管理在连接对象里，它们只能在连接断开时被释放，所以长期连接积累下来，内存越来越大，最后OOM，MySQL就会异常Restart**。建议使用一段时间后执行 mysql_reset_connection初始化连接资源。会直接恢复到刚刚创建的状态。  



#### 查询缓存

连接建立后，执行查询语句的时候，会先查询缓存，Mysql会先校验这个sql是否执行过，以Key-Value的形式缓存在内存中，Key是查询语句，Value是查询的结果。如果缓存key被命中，就会直接返回给客户端，如果没有命中，就会执行后续的操作，完成后也会把结果缓存起来，方便下一次调用。当然在真正执行缓存查询的时候还是会校验用户的权限，是否有该表的查询条件.

**大多数情况下不建议使用查询缓存，因为往往弊大于利。**

查询缓存实现非常频繁，对一个表的更新，这个表所有的查询缓存都会被清空。Mysql 8.0 版本后删除了缓存的功能，官方也是认为该功能在实际的应用场景比较少，所以直接删掉了。  

#### 分析器

MySQL 没有命中缓存，那么就会进入分析器，分析器主要是用来分析SQL语句是做什么的，分析器也会分为几步：

-  词法分析  ：分析器会识别SQL语句中的字符串分析是什么，代表什么。从你输入的"select"关键字识别出来，是一条查询语句，把字符串 " student " 识别为 " 表名student ",字符串 " id " 识别为 " 列id ".

- 语法分析：判断你输入的SQL是否正确，是否符合MySQL的语法。如果语句不对，就会出现熟悉的提示信息："You have an error in your SQL syntax"   

完成这2步之后，mysql就准备开始执行了，但是如何执行，怎么执行是最好的结果呢？这个时候就需要优化器。

#### 优化器

- 优化器就是在表中有多个索引时，决定使用哪个索引，多表关联时，决定表间连接顺序，优化器根据自己的优化算法进行选择执行效率最好的一个方案。  

#### 执行器

- 在经过分析器知道要做什么，优化器知道该如何做后，进入执行器阶段。先判断此表有无查询权限，如果没有，返回错误信息。如果有权限，就打开表执行，执行器依据引擎定义，使用指定引擎interface，调用InnoDB引擎interface取表第一行，判断 id == 10 ,不是，跳到下一行，重复判断，找到后存入结果集中。

### 总结

- Mysql 主要分为Server层和引擎层，Server层主要包括连接器、查询缓存、分析器、优化器、执行器，同时还有一个日志模块（binlog），这个日志模块所有执行引擎都可以共用。

  引擎层是插件式的，目前主要包括，MyISAM,InnoDB,Memory等。

- 查询语句的执行流程如下：权限校验（如果命中缓存）---》查询缓存---》分析器---》优化器---》权限校验---》执行器---》引擎

### 参考

- 《mysql专栏45讲》
- 《高性能mysql第三版》

  

  
















